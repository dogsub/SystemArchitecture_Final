name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Build Backend
        run: |
          cd DREANK_BACK-back
          ./gradlew build

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host *" > ~/.ssh/config
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy to Server
        env:
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
        run: |
          ls -al ./DREANK_BACK-back/build/libs/
          scp -o StrictHostKeyChecking=no ./DREANK_BACK-back/build/libs/dreank-0.0.1-SNAPSHOT.jar ubuntu@${{ secrets.DEPLOY_HOST }}:/home/ubuntu/deploy/dreank-backend-0.0.1-SNAPSHOT.jar
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.DEPLOY_HOST }} <<EOF
            export SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
            export SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
            export SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
            nohup java -jar /home/ubuntu/deploy/dreank-backend-0.0.1-SNAPSHOT.jar > /home/ubuntu/deploy/backend.log 2>&1 &
          EOF